<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Noirkel 's blog</title><link>https://noirkelo.github.io/blog/blog/rust/</link><description>Recent content in Rust on Noirkel 's blog</description><generator>Hugo -- gohugo.io</generator><language>zh-Hans</language><lastBuildDate>Mon, 06 Mar 2023 00:00:00 +0000</lastBuildDate><atom:link href="https://noirkelo.github.io/blog/blog/rust/index.xml" rel="self" type="application/rss+xml"/><item><title>æµ‹è¯•</title><link>https://noirkelo.github.io/blog/%E6%B5%8B%E8%AF%95/</link><pubDate>Mon, 06 Mar 2023 00:00:00 +0000</pubDate><guid>https://noirkelo.github.io/blog/%E6%B5%8B%E8%AF%95/</guid><description>è¿™ä¸ªæ˜¯å¤åˆ¶è¿‡æ¥æµ‹è¯•çš„ å®Œæ•´ä»£ç 
flowchart LR Client-- inbound --&amp;gt;Relay Relay-- outbound --&amp;gt;Server Server--&amp;gt;Relay Relay--&amp;gt;Client æœ€è¿‘åˆšæŠŠ Rust è¯­æ³•å’Œå¸¸ç”¨åŠŸèƒ½è¿‡äº†ä¸€éï¼Œåˆšå¥½å†™ä¸€ä¸ªç®€å•çš„ TCP relay ç»ƒç»ƒæ‰‹ã€‚å› ä¸º eBPF çœ‹èµ·æ¥å¥½åƒæœ‰ç‚¹éš¾ï¼Œè¿˜æ²¡å’‹å­¦ï¼Œå°±å…ˆå®ç°ä¸€ä¸ªç”¨æˆ·æ€ copy çš„ç‰ˆæœ¬ã€‚
åˆå§‹åŒ–é¡¹ç›® cargo new tproxy cd tproxy ä¾èµ– å¼‚æ­¥è¿è¡Œæ—¶ä½¿ç”¨ tokioï¼ˆç›´æ¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€‚ã€‚ã€‚å¯¹æˆ‘è¿™ç§èœé¸¡æ¥è¯´ï¼ŒRust å¤§æ¦‚æ˜¯å†™å‡ºé«˜æ€§èƒ½ç¨‹åºçš„å”¯ä¸€æ–¹å¼ï¼ŒCPP ç®€ç›´ä¸æ˜¯äººå­¦çš„ï¼‰
[dependencies] +anyhow = &amp;#34;1.0&amp;#34; +tokio = { version = &amp;#34;1&amp;#34;, features = [&amp;#34;full&amp;#34;] } Echo Server å…ˆå°è¯•è·‘é€š echo serveï¼Œè¿™åº”è¯¥èƒ½ç®—æ˜¯ç½‘ç»œç¼–ç¨‹çš„ hello world äº†å§ ğŸ˜‚ï¼š
use anyhow::Result; use tokio::io; use tokio::net::TcpListener; #[tokio::main] async fn main() -&amp;gt; Result&amp;lt;()&amp;gt; { let listener = TcpListener::bind(&amp;#34;127.</description><content:encoded><![CDATA[<p>è¿™ä¸ªæ˜¯å¤åˆ¶è¿‡æ¥æµ‹è¯•çš„
<a href="https://github.com/maolonglong/tproxy">å®Œæ•´ä»£ç </a></p>





<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">flowchart LR
    Client-- inbound --&gt;Relay
    Relay-- outbound --&gt;Server
    Server--&gt;Relay
    Relay--&gt;Client</code></pre>
<p>æœ€è¿‘åˆšæŠŠ Rust è¯­æ³•å’Œå¸¸ç”¨åŠŸèƒ½è¿‡äº†ä¸€éï¼Œåˆšå¥½å†™ä¸€ä¸ªç®€å•çš„ TCP relay ç»ƒç»ƒæ‰‹ã€‚å› ä¸º eBPF çœ‹èµ·æ¥å¥½åƒæœ‰ç‚¹éš¾ï¼Œè¿˜æ²¡å’‹å­¦ï¼Œå°±å…ˆå®ç°ä¸€ä¸ªç”¨æˆ·æ€ copy çš„ç‰ˆæœ¬ã€‚</p>
<!-- more -->
<h2 id="åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®</h2>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cargo new tproxy
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> tproxy</span></span></code></pre></div>
<h3 id="ä¾èµ–">ä¾èµ–</h3>
<p>å¼‚æ­¥è¿è¡Œæ—¶ä½¿ç”¨ tokioï¼ˆç›´æ¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šã€‚ã€‚ã€‚å¯¹æˆ‘è¿™ç§èœé¸¡æ¥è¯´ï¼ŒRust å¤§æ¦‚æ˜¯å†™å‡ºé«˜æ€§èƒ½ç¨‹åºçš„å”¯ä¸€æ–¹å¼ï¼ŒCPP ç®€ç›´ä¸æ˜¯äººå­¦çš„ï¼‰</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> [dependencies]
</span></span><span class="line"><span class="cl"><span class="gi">+anyhow = &#34;1.0&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+tokio = { version = &#34;1&#34;, features = [&#34;full&#34;] }
</span></span></span></code></pre></div>
<h3 id="echo-server">Echo Server</h3>
<p>å…ˆå°è¯•è·‘é€š echo serveï¼Œè¿™åº”è¯¥èƒ½ç®—æ˜¯ç½‘ç»œç¼–ç¨‹çš„ hello world äº†å§ ğŸ˜‚ï¼š</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">io</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">net</span>::<span class="n">TcpListener</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">&#34;127.0.0.1:6101&#34;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;accepting inbound connections&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">inbound</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listener</span><span class="p">.</span><span class="n">accept</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å‡ ä¹å’Œ Golang é‡Œ go func() ä¸€æ ·ç®€å•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inbound</span><span class="p">.</span><span class="n">split</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span>::<span class="n">copy</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">w</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>
<p>æ³¨æ„ <code>tokio::net::TcpListener</code> ä¸è¦å¯¼æˆ <code>std::net::TcpListener</code>ï¼Œé”™è¯¯å¤„ç†å…ˆç”¨ anyhow ä¸€è‚¡è„‘å¾€å¤–æŠ›ã€‚æœ€åå°±æ˜¯æ¯æ¥ä¸€ä¸ªè¿æ¥ï¼Œéƒ½å¯ä¸€ä¸ª async task å¤„ç†ï¼Œå› ä¸ºæ˜¯ echo serverï¼Œæ‰€ä»¥å°±åªéœ€è¦æŠŠè¿æ¥é‡Œè¯»åˆ°çš„å†…å®¹åŸæ ·è¿”å›ã€‚</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¿è¡Œ</span>
</span></span><span class="line"><span class="cl">cargo run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å¦èµ·ä¸€ä¸ªç»ˆç«¯ï¼Œç”¨ telnet æµ‹è¯•</span>
</span></span><span class="line"><span class="cl">$ telnet 127.0.0.1 <span class="m">6101</span>
</span></span><span class="line"><span class="cl">Trying 127.0.0.1...
</span></span><span class="line"><span class="cl">Connected to 127.0.0.1.
</span></span><span class="line"><span class="cl">Escape character is <span class="s1">&#39;^]&#39;</span>.
</span></span><span class="line"><span class="cl">hello
</span></span><span class="line"><span class="cl">hello
</span></span><span class="line"><span class="cl">world
</span></span><span class="line"><span class="cl">world</span></span></code></pre></div>
<h2 id="æœ€åŸºç¡€å®ç°">æœ€åŸºç¡€å®ç°</h2>
<p>æœ‰äº†ä¸Šé¢ echo server çš„ä¾‹å­ï¼Œç»§ç»­å®ç° relay å°±éå¸¸ç®€å•äº†ï¼š</p>
<ul>
<li>echo server ä¸­åŒ…å«ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®å¤åˆ¶ï¼š
<ul>
<li>inbound connection -&gt; ç”¨æˆ·ç¨‹åº</li>
<li>inbound connection &lt;- ç”¨æˆ·ç¨‹åº</li>
</ul>
</li>
<li>å‚è€ƒæ–‡ç« æœ€å¼€å§‹çš„å›¾ï¼Œä¸ºäº†å®ç° relayï¼Œæˆ‘ä»¬éœ€è¦å››ä¸ªæ–¹å‘çš„æ•°æ®å¤åˆ¶ï¼š
<ul>
<li>inbound connection -&gt; ç”¨æˆ·ç¨‹åº</li>
<li>ç”¨æˆ·ç¨‹åº -&gt; outbound connection</li>
<li>ç”¨æˆ·ç¨‹åº &lt;- outbound connection</li>
<li>inbound connection &lt;- ç”¨æˆ·ç¨‹åº</li>
</ul>
</li>
</ul>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">TcpListener</span><span class="p">,</span><span class="w"> </span><span class="n">TcpStream</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">&#34;127.0.0.1:6101&#34;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;accepting inbound connections&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">inbound</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listener</span><span class="p">.</span><span class="n">accept</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è¿™é‡Œè¿æ¥çš„ 127.0.0.1:8888 å¯ä»¥æ˜¯ä»»ä½•åŸºäº TCP çš„æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// æˆ‘ç”¨äº† Golang è·‘çš„ HTTP æœåŠ¡ï¼Œè¿˜å¯ä»¥å°è¯•è¿æ¥ MySQL æˆ–è€… Redis...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">outbound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="s">&#34;127.0.0.1:8888&#34;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">ri</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wi</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inbound</span><span class="p">.</span><span class="n">split</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outbound</span><span class="p">.</span><span class="n">split</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">client_to_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">io</span>::<span class="n">copy</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ri</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wo</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">wo</span><span class="p">.</span><span class="n">shutdown</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">server_to_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">io</span>::<span class="n">copy</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wi</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">wi</span><span class="p">.</span><span class="n">shutdown</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// try_join ç­‰å¾…ä»»æ„ä¸€ä¸ª future ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">tokio</span>::<span class="fm">try_join!</span><span class="p">(</span><span class="n">client_to_server</span><span class="p">,</span><span class="w"> </span><span class="n">server_to_client</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Ok</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">anyhow</span>::<span class="n">Error</span><span class="o">&gt;</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>
<details>
  <summary>Golang HTTP server code</summary>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">greet</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello World! %s&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// go run main.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">greet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8888&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</details>
<p>æµ‹è¯• relay æ•ˆæœï¼š</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># è¿è¡Œ</span>
</span></span><span class="line"><span class="cl">cargo run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Rust TCP relay</span>
</span></span><span class="line"><span class="cl">$ curl http://127.0.0.1:6101
</span></span><span class="line"><span class="cl">Hello World! 2023-03-12 16:36:31.084117 +0800 CST <span class="nv">m</span><span class="o">=</span>+1890.305817001
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Golang HTTP server</span>
</span></span><span class="line"><span class="cl">$ curl http://127.0.0.1:8888
</span></span><span class="line"><span class="cl">Hello World! 2023-03-12 16:36:35.356403 +0800 CST <span class="nv">m</span><span class="o">=</span>+1894.578158751</span></span></code></pre></div>
<p>å°±è¿™ï¼Ÿï¼Ÿå¥½äº†ï¼Ÿæ˜¯çš„ã€‚ã€‚ã€‚å·²ç»èƒ½è·‘äº†ã€‚ä½†æ˜¯è¿™ä¸ªç¨‹åºè¿˜å¾ˆè„†å¼±ï¼Œå‡ ä¹æ²¡æœ‰é”™è¯¯å¤„ç†ï¼Œæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼Œä¹Ÿæ²¡æœ‰ graceful shutdownã€‚</p>
<h2 id="è¿›ä¸€æ­¥å®Œå–„">è¿›ä¸€æ­¥å®Œå–„</h2>
<h3 id="æ·»åŠ ä¾èµ–">æ·»åŠ ä¾èµ–</h3>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> [dependencies]
</span></span><span class="line"><span class="cl"> anyhow = &#34;1.0&#34;
</span></span><span class="line"><span class="cl"><span class="gi">+backon = &#34;0.4&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+clap = { version = &#34;4.1.8&#34;, features = [&#34;derive&#34;] }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> tokio = { version = &#34;1&#34;, features = [&#34;full&#34;] }
</span></span><span class="line"><span class="cl"><span class="gi">+tracing = &#34;0.1&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+tracing-subscriber = &#34;0.3&#34;
</span></span></span></code></pre></div>
<h3 id="æ•´ç†ä»£ç ç»“æ„">æ•´ç†ä»£ç ç»“æ„</h3>
<p>æŠŠä¸»è¦é€»è¾‘ç§»åˆ° <code>src/lib.rs</code>ï¼Œå•ç‹¬å¤„ç† Listener å’Œ Handlerï¼Œå¹¶ä¸”åŠ ä¸Šäº›æ—¥å¿—å’Œé”™è¯¯å¤„ç†ï¼š</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">net</span>::<span class="n">TcpListener</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">init</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tproxy</span>::<span class="n">run</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TcpListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">&#34;127.0.0.1:6101&#34;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;127.0.0.1:8888&#34;</span><span class="p">.</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">AsyncWriteExt</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">TcpListener</span><span class="p">,</span><span class="w"> </span><span class="n">TcpStream</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tracing</span>::<span class="p">{</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">Listener</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">listener</span>: <span class="nc">TcpListener</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ç›®æ ‡æœåŠ¡çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">to_addr</span>: <span class="nc">SocketAddr</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">Handler</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inbound</span>: <span class="nc">TcpStream</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">outbound</span>: <span class="nc">TcpStream</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="n">listener</span>: <span class="nc">TcpListener</span><span class="p">,</span><span class="w"> </span><span class="n">to_addr</span>: <span class="nc">SocketAddr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Listener</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">to_addr</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">error!</span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;failed to accept&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Listener</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">info!</span><span class="p">(</span><span class="s">&#34;accepting inbound connections&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">inbound</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">listener</span><span class="p">.</span><span class="n">accept</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="fm">info!</span><span class="p">(</span><span class="o">?</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;new connection&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">outbound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TcpStream</span>::<span class="n">connect</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">to_addr</span><span class="p">).</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outbound</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="fm">error!</span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;connection error&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">inbound</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">outbound</span>: <span class="nc">outbound</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">handler</span><span class="p">.</span><span class="n">run</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="fm">info!</span><span class="p">(</span><span class="o">?</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;connection closed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="fm">error!</span><span class="p">(</span><span class="o">?</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;connection error&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">ri</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wi</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">inbound</span><span class="p">.</span><span class="n">split</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">outbound</span><span class="p">.</span><span class="n">split</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">client_to_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">io</span>::<span class="n">copy</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ri</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wo</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">wo</span><span class="p">.</span><span class="n">shutdown</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">server_to_client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">io</span>::<span class="n">copy</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wi</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">wi</span><span class="p">.</span><span class="n">shutdown</span><span class="p">().</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">tokio</span>::<span class="fm">try_join!</span><span class="p">(</span><span class="n">client_to_server</span><span class="p">,</span><span class="w"> </span><span class="n">server_to_client</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>
<h3 id="graceful-shutdown">Graceful Shutdown</h3>
<p>æœåŠ¡å…³é—­å‰ï¼Œæœ€å¥½ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å¤„ç†ç»“æŸï¼Œç­‰å¾…æ—¶é—´è¿‡é•¿å†å¼ºè¡Œæ€æ­»ï¼Œå‡å°‘è¿æ¥çªç„¶æ–­å¼€ï¼Œç»™ä¸šåŠ¡å¸¦æ¥çš„å½±å“ã€‚</p>
<p>åœ¨ Golang ä¸­ï¼Œå¯ä»¥ç”¨ <code>sync.WaitGroup</code> æˆ–è€…é  <code>close(channel)</code> æ¥é€šçŸ¥ï¼Œtokio æä¾›äº†å’Œ channel <strong>ç±»ä¼¼</strong> çš„ mpsc (multi-producer, single-consumer queue)ã€‚</p>
<p>å®ç°æ€è·¯ï¼š</p>
<ol>
<li>Listener å’Œæ¯ä¸ª Handler éƒ½æŒæœ‰ <code>mpsc::Sender</code></li>
<li>Listener æ¥æ”¶åˆ° Ctrl-C ä¿¡å·åï¼Œdrop æ‰è‡ªå·±çš„ senderï¼Œç„¶å <strong>ç­‰å¾…</strong> <code>mpsc::Receiver</code> è¿”å›</li>
<li>æ‰€æœ‰ Handler éƒ½å¤„ç†å®Œè¯·æ±‚ï¼Œdrop è‡ªå·±çš„ sender</li>
<li>Listener ç­‰å¾… receiver è¿”å› <code>None</code>ï¼ˆæ‰€æœ‰ sender éƒ½è¢« drop åï¼Œè¿”å›çš„ç‰¹æ®Šå€¼ï¼‰ï¼Œå®Œæˆ graceful shutdownã€‚</li>
</ol>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> struct Listener {
</span></span><span class="line"><span class="cl">     listener: TcpListener,
</span></span><span class="line"><span class="cl">     to_addr: SocketAddr,
</span></span><span class="line"><span class="cl"><span class="gi">+    shutdown_complete_tx: mpsc::Sender&lt;()&gt;,
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> struct Handler {
</span></span><span class="line"><span class="cl">     inbound: TcpStream,
</span></span><span class="line"><span class="cl">     outbound: TcpStream,
</span></span><span class="line"><span class="cl"><span class="gi">+    _shutdown_complete: mpsc::Sender&lt;()&gt;,
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> }
</span></span></code></pre></div>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">const</span><span class="w"> </span><span class="no">GRACEFUL_SHUTDOWN_TIMEOUT</span>: <span class="nc">Duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="n">listener</span>: <span class="nc">TcpListener</span><span class="p">,</span><span class="w"> </span><span class="n">to_addr</span>: <span class="nc">SocketAddr</span><span class="p">,</span><span class="w"> </span><span class="n">shutdown</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">shutdown_complete_tx</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">shutdown_complete_rx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpsc</span>::<span class="n">channel</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Listener</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">listener</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">to_addr</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">shutdown_complete_tx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tokio</span>::<span class="fm">select!</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="fm">error!</span><span class="p">(</span><span class="n">cause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">%</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;failed to accept&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shutdown</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="fm">info!</span><span class="p">(</span><span class="s">&#34;shutting down&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">Listener</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">shutdown_complete_tx</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">..</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">drop</span><span class="p">(</span><span class="n">shutdown_complete_tx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">time</span>::<span class="n">timeout</span><span class="p">(</span><span class="no">GRACEFUL_SHUTDOWN_TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">shutdown_complete_rx</span><span class="p">.</span><span class="n">recv</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="n">is_err</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="fm">warn!</span><span class="p">(</span><span class="s">&#34;graceful shutdown timeout&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> impl Listener {
</span></span><span class="line"><span class="cl">     async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
</span></span><span class="line"><span class="cl">         info!(&#34;accepting inbound connections&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         loop {
</span></span><span class="line"><span class="cl">             let (inbound, addr) = self.listener.accept().await?;
</span></span><span class="line"><span class="cl">             info!(?addr, &#34;new connection&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             let outbound = TcpStream::connect(&amp;self.to_addr).await;
</span></span><span class="line"><span class="cl">             if let Err(err) = outbound {
</span></span><span class="line"><span class="cl">                 error!(cause = ?err, &#34;connection error&#34;);
</span></span><span class="line"><span class="cl">                 continue;
</span></span><span class="line"><span class="cl">             }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             let mut handler = Handler {
</span></span><span class="line"><span class="cl">                 inbound,
</span></span><span class="line"><span class="cl">                 outbound: outbound.unwrap(),
</span></span><span class="line"><span class="cl"><span class="gi">+                _shutdown_complete: self.shutdown_complete_tx.clone(),
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>             };
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             tokio::spawn(async move {
</span></span><span class="line"><span class="cl">                 match handler.run().await {
</span></span><span class="line"><span class="cl">                     Ok(_) =&gt; {
</span></span><span class="line"><span class="cl">                         info!(?addr, &#34;connection closed&#34;);
</span></span><span class="line"><span class="cl">                     }
</span></span><span class="line"><span class="cl">                     Err(err) =&gt; {
</span></span><span class="line"><span class="cl">                         error!(?addr, cause = ?err, &#34;connection error&#34;);
</span></span><span class="line"><span class="cl">                     }
</span></span><span class="line"><span class="cl">                 }
</span></span><span class="line"><span class="cl">             });
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></div>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> use anyhow::Result;
</span></span><span class="line"><span class="cl"> use tokio::net::TcpListener;
</span></span><span class="line"><span class="cl"><span class="gi">+use tokio::signal;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>
</span></span><span class="line"><span class="cl"> #[tokio::main]
</span></span><span class="line"><span class="cl"> async fn main() -&gt; Result&lt;()&gt; {
</span></span><span class="line"><span class="cl">     tracing_subscriber::fmt::init();
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     tproxy::run(
</span></span><span class="line"><span class="cl">         TcpListener::bind(&#34;127.0.0.1:6101&#34;).await?,
</span></span><span class="line"><span class="cl">         &#34;127.0.0.1:8888&#34;.parse().unwrap(),
</span></span><span class="line"><span class="cl"><span class="gi">+        signal::ctrl_c(),
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     )
</span></span><span class="line"><span class="cl">     .await;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     Ok(())
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></div>
<h3 id="ä»å‘½ä»¤è¡Œå‚æ•°è§£æé…ç½®">ä»å‘½ä»¤è¡Œå‚æ•°è§£æé…ç½®</h3>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">net</span>::<span class="n">SocketAddr</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">anyhow</span>::<span class="nb">Result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">clap</span>::<span class="n">Parser</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">net</span>::<span class="n">TcpListener</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">signal</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Parser, Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[command(author, version, about, long_about = None)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">Args</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="sd">/// Listen address
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">    </span><span class="cp">#[arg(short, long, default_value = </span><span class="s">&#34;127.0.0.1:6101&#34;</span><span class="cp">)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">from</span>: <span class="nc">SocketAddr</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="sd">/// Address which relay to, like: 1.2.3.4:9999
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">    </span><span class="cp">#[arg(short, long)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">to</span>: <span class="nc">SocketAddr</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[tokio::main]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tracing_subscriber</span>::<span class="n">fmt</span>::<span class="n">init</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Args</span>::<span class="n">parse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tproxy</span>::<span class="n">run</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">TcpListener</span>::<span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">from</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">args</span><span class="p">.</span><span class="n">to</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">signal</span>::<span class="n">ctrl_c</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>
<p>clap çš„ derive å®ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„ CLIï¼š</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cargo run -- --help
</span></span><span class="line"><span class="cl">    Finished dev <span class="o">[</span>unoptimized + debuginfo<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> in 0.07s
</span></span><span class="line"><span class="cl">     Running <span class="sb">`</span>target/debug/tproxy --help<span class="sb">`</span>
</span></span><span class="line"><span class="cl">Minimal TCP relay <span class="o">(</span>proxy<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage: tproxy <span class="o">[</span>OPTIONS<span class="o">]</span> --to &lt;TO&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">  -f, --from &lt;FROM&gt;  Listen address <span class="o">[</span>default: 127.0.0.1:6101<span class="o">]</span>
</span></span><span class="line"><span class="cl">  -t, --to &lt;TO&gt;      Address which relay to, like: 1.2.3.4:9999
</span></span><span class="line"><span class="cl">  -h, --help         Print <span class="nb">help</span>
</span></span><span class="line"><span class="cl">  -V, --version      Print version</span></span></code></pre></div>
<h3 id="accept-é‡è¯•">Accept é‡è¯•</h3>
<p>æœ€åä¸€ä¸ªå¯æœ‰å¯æ— çš„ä¼˜åŒ–ï¼Œä»”ç»†çœ‹ <code>Listener::run</code>ï¼Œå¦‚æœ <code>accept()</code> å¤±è´¥äº†ï¼Œæ•´ä¸ªç¨‹åºå°±ç›´æ¥é€€å‡ºäº†ï¼Œå¯ä»¥åŠ ä¸Šé‡è¯•ï¼Œå¢åŠ äº›å®¹é”™ç‡ã€‚</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">impl</span><span class="w"> </span><span class="n">Listener</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">inbound</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">listener</span><span class="p">.</span><span class="n">accept</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">..</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span></span></span></code></pre></div>
<p>åˆšå¥½å‰å‡ å¤©çœ‹äº† <a href="https://github.com/Xuanwo">@Xuanwo</a> å¤§ä½¬ä»‹ç» Rust é”™è¯¯é‡è¯•åº“ <a href="https://github.com/Xuanwo/backon">backon</a> çš„ <a href="https://xuanwo.io/reports/2023-09/">æ–‡ç« </a>ï¼Œå°±æ‹¿æ¥ç”¨äº†ï¼š</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"> impl Listener {
</span></span><span class="line"><span class="cl">     async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
</span></span><span class="line"><span class="cl">         info!(&#34;accepting inbound connections&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+        let accept = || async { self.listener.accept().await };
</span></span></span><span class="line"><span class="cl"><span class="gi">+        let backoff_builder = ExponentialBuilder::default()
</span></span></span><span class="line"><span class="cl"><span class="gi">+            .with_jitter()
</span></span></span><span class="line"><span class="cl"><span class="gi">+            .with_max_times(64);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>
</span></span><span class="line"><span class="cl">         loop {
</span></span><span class="line"><span class="cl"><span class="gd">-            let (inbound, addr) = self.listener.accept().await?;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+            let (inbound, addr) = accept.retry(&amp;backoff_builder).await?;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>             info!(?addr, &#34;new connection&#34;);
</span></span><span class="line"><span class="cl">             ...
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></div>
<h2 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h2>
<p><a href="https://github.com/maolonglong/tproxy">https://github.com/maolonglong/tproxy</a></p>
]]></content:encoded></item></channel></rss>